<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>다다익선 제주 현장학습</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* 기본 폰트 및 배경 설정 */
        body {
            font-family: 'Pretendard', sans-serif;
        }
        /* 활성 탭 스타일 */
        .tab-active {
            background-color: #3b82f6; /* blue-600 */
            color: white;
        }
        /* 비활성 탭 스타일 */
        .tab-inactive {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
        }
        /* 사진 미리보기 플레이스홀더 스타일 */
        .photo-placeholder {
            border: 2px dashed #4b5563; /* gray-600 */
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af; /* gray-400 */
            background-color: #1f2937; /* gray-800 */
        }

        /* 인쇄용 스타일 */
        @media print {
            body * {
                visibility: hidden;
            }
            #result-modal, #result-modal * {
                visibility: visible;
            }
            #result-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: visible;
                background-color: white;
            }
            #result-modal-content, #result-content {
                color: black;
                background-color: white;
            }
            #result-content .p-3 {
                border: 1px solid #ccc;
                margin-bottom: 1rem;
                background-color: #f9f9f9 !important;
            }
            #result-modal h2, #result-content h3 {
                color: black !important;
            }
            #result-modal-header button, #print-btn {
                display: none;
            }
        }
        
        /* PDF 생성 로딩 오버레이 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 진행 표시기 스타일 */
        .progress-active {
            background-color: #10b981; /* green-500 */
        }
        .progress-inactive {
            background-color: #4b5563; /* gray-600 */
        }
        .progress-completed {
            background-color: #10b981; /* green-500 */
        }
        .progress-line-active {
            background-color: #10b981; /* green-500 */
        }
        .progress-line-inactive {
            background-color: #4b5563; /* gray-600 */
        }
        
        /* 알림 애니메이션 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .notification {
            animation: fadeIn 0.3s ease-out forwards, fadeOut 0.5s ease-in forwards 2.5s;
        }
        
        /* 백업 안내 섹션 */
        .backup-guide {
            border: 1px solid #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-4 max-w-4xl">
        <header class="text-center my-6">
            <h1 class="text-4xl font-bold text-blue-300">✈️ 다다익선 제주 현장학습</h1>
            <p class="text-gray-400 mt-2">2박 3일, 우리들의 특별한 제주 이야기</p>
            
            <!-- 진행률 표시 -->
            <div class="mt-4 flex justify-center items-center space-x-4">
                <div id="progress-day1" class="flex items-center space-x-2">
                    <span class="w-3 h-3 rounded-full progress-inactive" id="progress-dot-1"></span>
                    <span class="text-sm text-gray-400" id="progress-text-1">1일차</span>
                </div>
                <div class="w-8 h-0.5 progress-line-inactive" id="progress-line-1-2"></div>
                <div id="progress-day2" class="flex items-center space-x-2">
                    <span class="w-3 h-3 rounded-full progress-inactive" id="progress-dot-2"></span>
                    <span class="text-sm text-gray-400" id="progress-text-2">2일차</span>
                </div>
                <div class="w-8 h-0.5 progress-line-inactive" id="progress-line-2-3"></div>
                <div id="progress-day3" class="flex items-center space-x-2">
                    <span class="w-3 h-3 rounded-full progress-inactive" id="progress-dot-3"></span>
                    <span class="text-sm text-gray-400" id="progress-text-3">3일차</span>
                </div>
            </div>
        </header>

        <!-- 백업 안내 섹션 -->
        <div id="backup-guide" class="backup-guide p-4 rounded-lg mb-6">
            <h3 class="text-lg font-semibold text-blue-300 mb-2">💾 작업 저장 안내</h3>
            <p class="text-gray-300 mb-2">작성 내용은 <span class="text-green-300">자동으로 저장</span>되지만, <strong>브라우저를 바꾸거나 다른 기기에서 계속 작업하려면</strong> 아래 방법을 따라주세요:</p>
            <ol class="list-decimal list-inside text-gray-300 space-y-1 ml-2">
                <li><span class="text-green-300 font-medium">"작업 백업하기" 버튼을 눌러</span> 작업을 파일로 저장하세요</li>
                <li>저장된 파일을 이메일, 메신저, 클라우드에 보관하세요</li>
                <li>다른 기기에서 작업을 계속하려면 "백업 불러오기"로 저장한 파일을 선택하세요</li>
            </ol>
            <div class="text-right mt-2">
                <button id="hide-guide-btn" class="text-sm text-gray-400 hover:text-white">닫기</button>
            </div>
        </div>

        <div id="tab-buttons" class="flex flex-wrap justify-center space-x-1 rounded-lg p-1 bg-gray-800 mb-6">
            <button data-tab="guide" class="tab-button flex-1 py-2 px-4 rounded-md text-sm sm:text-base font-semibold transition-colors duration-300 tab-active">안내/일정</button>
            <button data-tab="day1" class="tab-button flex-1 py-2 px-4 rounded-md text-sm sm:text-base font-semibold transition-colors duration-300 tab-inactive">1일차 학습</button>
            <button data-tab="day2" class="tab-button flex-1 py-2 px-4 rounded-md text-sm sm:text-base font-semibold transition-colors duration-300 tab-inactive">2일차 학습</button>
            <button data-tab="day3" class="tab-button flex-1 py-2 px-4 rounded-md text-sm sm:text-base font-semibold transition-colors duration-300 tab-inactive">3일차 학습</button>
        </div>

        <form id="main-form">
            <main id="tab-content">
                <div id="guide" class="tab-panel space-y-6">
                    <div id="guide-content">
                        <div class="bg-slate-800 p-6 rounded-lg shadow-xl">
                            <h2 class="text-2xl font-bold text-blue-300 mb-4 border-b-2 border-blue-500 pb-2">기본 정보 입력</h2>
                            
                            <!-- 개인/팀 모드 선택 -->
                            <div class="mb-6 p-4 bg-slate-700 rounded-lg">
                                <div class="flex items-center space-x-6">
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="mode" value="individual" id="mode_individual" class="savable" checked>
                                        <span class="text-gray-300">👤 개인 모드</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="mode" value="team" id="mode_team" class="savable">
                                        <span class="text-gray-300">👥 팀 모드</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 개인 정보 -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div>
                                    <label for="student_school" class="block text-sm font-medium text-gray-300">학교</label>
                                    <input type="text" id="student_school" class="savable mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                </div>
                                <div>
                                    <label for="student_grade" class="block text-sm font-medium text-gray-300">학년</label>
                                    <input type="text" id="student_grade" class="savable mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                </div>
                                <div>
                                    <label for="student_name" class="block text-sm font-medium text-gray-300">이름 <span id="name_label_suffix"></span></label>
                                    <input type="text" id="student_name" class="savable mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                </div>
                            </div>

                            <!-- 팀 정보 (팀 모드일 때만 표시) -->
                            <div id="team_info_section" class="mb-6 p-4 bg-slate-700 rounded-lg hidden">
                                <h3 class="text-lg font-semibold text-blue-300 mb-3">🏆 팀 정보</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label for="team_name" class="block text-sm font-medium text-gray-300">팀명</label>
                                        <input type="text" id="team_name" placeholder="예: 제주 탐험대" class="savable mt-1 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label for="team_role" class="block text-sm font-medium text-gray-300">내 역할</label>
                                        <select id="team_role" class="savable mt-1 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm p-2">
                                            <option value="">역할 선택</option>
                                            <option value="팀장">👑 팀장</option>
                                            <option value="기록담당">📝 기록담당</option>
                                            <option value="사진담당">📸 사진담당</option>
                                            <option value="발표담당">🎤 발표담당</option>
                                            <option value="팀원">👥 팀원</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label for="team_members" class="block text-sm font-medium text-gray-300">팀원 목록 (쉼표로 구분)</label>
                                    <input type="text" id="team_members" placeholder="예: 김철수, 이영희, 박민수, 정수진" class="savable mt-1 block w-full bg-gray-600 border-gray-500 rounded-md shadow-sm p-2">
                                    <p class="text-xs text-gray-400 mt-1">팀장 포함 모든 팀원의 이름을 입력해주세요</p>
                                </div>
                            </div>
                            <h3 class="text-xl font-semibold text-blue-300 mb-4">인솔교사 비상 연락처</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" id="teacher1_name" placeholder="선생님 1 이름" class="savable block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                    <input type="tel" id="teacher1_contact" placeholder="선생님 1 연락처" class="savable block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" id="teacher2_name" placeholder="선생님 2 이름 (선택)" class="savable block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                    <input type="tel" id="teacher2_contact" placeholder="선생님 2 연락처 (선택)" class="savable block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" id="teacher3_name" placeholder="선생님 3 이름 (선택)" class="savable block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                    <input type="tel" id="teacher3_contact" placeholder="선생님 3 연락처 (선택)" class="savable block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-800 p-6 rounded-lg shadow-xl mt-6">
                            <h2 class="text-2xl font-bold text-blue-300 mb-4 border-b-2 border-blue-500 pb-2">전체 여행 일정</h2>
                            <div class="overflow-x-auto">
                               <table class="w-full text-left text-sm">
                                <thead class="bg-slate-700 text-gray-300"><tr><th class="p-3">시간</th><th class="p-3">활동 내용</th><th class="p-3">비고</th></tr></thead>
                                <tbody class="divide-y divide-slate-700">
                                    <tr class="bg-slate-900"><td colspan="3" class="font-bold p-2">📅 1일차</td></tr>
                                    <tr><td>8:30</td><td>대구공항 도착 및 수속 준비</td><td>국내선 1번 게이트 앞 집합</td></tr>
                                    <tr><td>10:10</td><td>대구공항 출발</td><td></td></tr>
                                    <tr><td>11:10</td><td>제주공항 도착</td><td>버스 탑승 및 인원 확인</td></tr>
                                    <tr><td>12:00~13:00</td><td>점심 식사 (고등어조림 또는 흑돼지)</td><td>제주시내 또는 이동 경로상 식당</td></tr>
                                    <tr><td>13:50~15:00</td><td>본태박물관</td><td>건축과 예술 감상 (사전답사 시 할인 가능성 확인)</td></tr>
                                    <tr><td>15:20~17:00</td><td>제주도립곶자왈도립공원</td><td>곶자왈 숲길 탐방 (편한 신발 필수)</td></tr>
                                    <tr><td>18:00~19:30</td><td>저녁 식사</td><td>제주시내 식당</td></tr>
                                    <tr><td>20:00</td><td>숙소 도착 및 방 배정</td><td>호텔에어시티제주</td></tr>
                                    <tr class="bg-slate-900"><td colspan="3" class="font-bold p-2">📅 2일차</td></tr>
                                    <tr><td>8:10</td><td>숙소 출발</td><td></td></tr>
                                    <tr><td>09:30~13:00</td><td>아쿠아플라넷 제주</td><td>아쿠아리움, 오션아레나 공연, 유미의세포들 특별전</td></tr>
                                    <tr><td>13:00~14:00</td><td>점심 식사 (돈까스 등)</td><td>아쿠아플라넷 內 푸드코트</td></tr>
                                    <tr><td>14:30~16:00</td><td>성읍 민속마을</td><td>제주의 옛 생활모습 체험 (해설사 프로그램 추천)</td></tr>
                                    <tr><td>16:20~18:00</td><td>산굼부리</td><td>문화유산 "평지에 생긴 거대한 화구, 제주 산굼부리 분화구"</td></tr>
                                    <tr><td>18:30~20:00</td><td>저녁 식사 (흑돼지구이)</td><td>성읍 또는 제주시 북귀 경로상 식당</td></tr>
                                    <tr><td>20:10~21:00</td><td>삼무공원</td><td>야간 산책</td></tr>
                                    <tr><td>21:00</td><td>숙소 도착 후 자유시간</td><td></td></tr>
                                    <tr class="bg-slate-900"><td colspan="3" class="font-bold p-2">📅 3일차</td></tr>
                                    <tr><td>8:50</td><td>숙소 출발 및 체크아웃</td><td></td></tr>
                                    <tr><td>09:10~10:40</td><td>아르떼뮤지엄</td><td>몰입형 미디어아트 전시 (빛의 명작보다 동선상 유리)</td></tr>
                                    <tr><td>11:10~12:30</td><td>국립제주박물관 또는 제주수목테마파크</td><td>제주의 역사와 문화에 관한 다양한 자료와 유물을 수집·보존</td></tr>
                                    <tr><td>12:30~13:30</td><td>점심 식사 (고기국수, 떡볶이 등)</td><td>공항 근처 식당</td></tr>
                                    <tr><td>13:40~14:40</td><td>용두암 및 용연구름다리</td><td>공항 가기 전 제주시 대표 명소 방문</td></tr>
                                    <tr><td>15:00</td><td>제주공항 도착 및 탑승 수속</td><td></td></tr>
                                    <tr><td>16:30</td><td>제주공항 출발</td><td></td></tr>
                                    <tr><td>17:35</td><td>대구공항 도착</td><td></td></tr>
                                </tbody>
                            </table>
                            </div>
                        </div>
                         <div class="bg-slate-800 p-6 rounded-lg shadow-xl mt-6">
                            <h2 class="text-2xl font-bold text-blue-300 mb-4 border-b-2 border-blue-500 pb-2">안전 수칙</h2>
                            <ul class="list-disc list-inside space-y-2 text-gray-300">
                               <li>단체 행동 시 항상 인솔 선생님의 지시에 따라주세요.</li>
                               <li>차량 이동 시에는 반드시 안전벨트를 착용합니다.</li>
                               <li>숙소에서는 다른 사람에게 피해를 주지 않도록 조용히 행동합니다.</li>
                               <li>위험한 장소나 행동은 피하고, 문제가 생기면 즉시 선생님께 알립니다.</li>
                            </ul>
                        </div>
                        <div class="bg-slate-800 p-6 rounded-lg shadow-xl mt-6">
                            <h2 class="text-2xl font-bold text-blue-300 mb-4 border-b-2 border-blue-500 pb-2">준비물 체크리스트</h2>
                            <div id="checklist" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-gray-300">
                                <label class="flex items-center space-x-2"><input type="checkbox" id="chk_passport" class="savable h-4 w-4 rounded"><span class="font-semibold text-blue-300">여권</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="chk_studentid" class="savable h-4 w-4 rounded"><span class="font-semibold text-blue-300">학생증/재학증명서</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="chk_clothes" class="savable h-4 w-4 rounded"><span>여벌 옷</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="chk_toiletries" class="savable h-4 w-4 rounded"><span>세면도구</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="chk_meds" class="savable h-4 w-4 rounded"><span>개인 상비약</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="chk_shoes" class="savable h-4 w-4 rounded"><span>편한 신발</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="chk_umbrella" class="savable h-4 w-4 rounded"><span>우산/우비</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" id="chk_charger" class="savable h-4 w-4 rounded"><span>충전기</span></label>
                            </div>
                            
                            <div class="mt-6 p-4 bg-blue-900 bg-opacity-50 rounded-lg border-2 border-blue-700">
                                <h3 class="text-lg font-semibold text-blue-300 mb-2">📄 여권 및 학생증 반드시 지참 안내</h3>
                                <p class="text-gray-300 mb-2">학생은 <span class="font-bold text-white">비행기 탑승 시 여권과 함께 학생증(재학증명서 등)이 필수</span>로 필요합니다:</p>
                                <ul class="list-disc list-inside space-y-1 text-gray-300 ml-2">
                                    <li><span class="text-blue-300 font-semibold">여권</span> - 유효기간 확인 필수</li>
                                    <li><span class="text-blue-300 font-semibold">학생증</span> - 비행기 탑승 및 학생 할인 적용을 위한 필수 서류</li>
                                    <li><span class="text-blue-300 font-semibold">재학증명서</span> - 학생증이 없는 경우 대체 가능</li>
                                </ul>
                                <p class="text-sm text-yellow-300 mt-2 font-medium">※ 학생증/재학증명서 없이 탑승 시 할인 혜택을 받지 못하거나 탑승이 거부될 수 있습니다.</p>
                            </div>
                            
                            <div class="mt-6 p-4 bg-red-900 bg-opacity-50 rounded-lg border border-red-700">
                                <h3 class="text-lg font-semibold text-red-300 mb-2">⚠️ 비행기 반입 금지 물품 주의사항</h3>
                                <p class="text-gray-300 mb-2">다음 물품은 기내 및 캐리어에 반입할 수 없습니다:</p>
                                <ul class="list-disc list-inside space-y-1 text-gray-300 ml-2">
                                    <li><span class="text-red-300 font-semibold">칼, 가위</span> - 기내 반입 금지 (수하물로만 가능)</li>
                                    <li><span class="text-red-300 font-semibold">보조 배터리</span> - 기내 휴대만 가능 (캐리어 및 수하물 수속 불가)</li>
                                    <li>액체류 100ml 초과 용기는 기내 반입 불가</li>
                                </ul>
                                <p class="text-sm text-gray-400 mt-2">* 보조 배터리는 반드시 기내에 휴대하고, 캐리어에 넣을 경우 비행기에 탑승할 수 없습니다.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 안내/일정 다운로드 버튼 -->
                    <div class="text-center mt-6">
                        <button id="download-guide-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
                            📋 안내/일정 PDF로 다운로드하기
                        </button>
                    </div>
                </div>

                <div id="day1" class="tab-panel space-y-6 hidden">
                    <div id="day1-content" class="bg-slate-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold text-blue-300 mb-4">1일차: 건축, 예술, 자연의 조화</h2>
                        <div class="space-y-4 mb-6 border-b-2 border-slate-700 pb-6">
                            <h3 class="text-xl font-semibold text-gray-200">본태박물관</h3>
                            <p class="text-gray-300">Q. 거울과 호박으로 우주를 표현한 '쿠사마 야요이'의 작품 이름은?</p>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_bontae" value="호박의 방" class="savable"><span>호박의 방</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_bontae" value="무한 거울의 방" class="savable"><span>무한 거울의 방</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_bontae" value="별이 빛나는 방" class="savable"><span>별이 빛나는 방</span></label>
                            </div>
                            <p class="text-gray-300 mt-4">📸 포토 미션: 안도 타다오의 멋진 건축물을 배경으로 사진을 찍어보세요.</p>
                            <input type="file" id="photo_bontae" accept="image/*" class="savable w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0"/>
                            <div class="mt-4 photo-placeholder"><img id="preview_bontae" class="max-h-60 rounded-lg"/></div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-xl font-semibold text-gray-200">곶자왈 도립공원</h3>
                            <p class="text-gray-300">Q. 화산 바위 위에 형성된 독특한 숲을 이르는 제주 고유어는?</p>
                             <div class="space-y-2">
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_gotjawal" value="오름" class="savable"><span>오름</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_gotjawal" value="올레길" class="savable"><span>올레길</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_gotjawal" value="곶자왈" class="savable"><span>곶자왈</span></label>
                            </div>
                            <p class="text-gray-300 mt-4">곶자왈 숲길을 걸으며 느낀 점(공기, 소리, 풍경 등)을 자유롭게 표현해 보세요.</p>
                            <textarea id="exp_gotjawal" class="savable w-full h-24 p-2 bg-gray-700 rounded-md"></textarea>
                        </div>
                    </div>
                    
                    <!-- 1일차 완료 버튼 -->
                    <div class="text-center">
                        <button id="complete-day1-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">
                            🎯 1일차 완료하고 이미지 저장하기
                        </button>
                        <div id="day1-status" class="mt-2 text-sm text-gray-400"></div>
                    </div>
                </div>

                <div id="day2" class="tab-panel space-y-6 hidden">
                     <div id="day2-content" class="bg-slate-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold text-blue-300 mb-4">2일차: 바닷속 신비와 제주의 옛 지혜</h2>
                        <div class="space-y-4 mb-6 border-b-2 border-slate-700 pb-6">
                            <h3 class="text-xl font-semibold text-gray-200">아쿠아플라넷 제주</h3>
                            <p class="text-gray-300">Q. 아쿠아플라넷의 가장 큰 상어 종류는 무엇일까요?</p>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_aqua" value="백상아리" class="savable"><span>백상아리</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_aqua" value="고래상어" class="savable"><span>고래상어</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_aqua" value="샌드타이거상어" class="savable"><span>샌드타이거상어</span></label>
                            </div>
                            <p class="text-gray-300 mt-4">'오션 아레나' 공연과 '유미의 세포들' 전시 중 더 재미있었던 것은?</p>
                            <textarea id="exp_aqua" class="savable w-full h-24 p-2 bg-gray-700 rounded-md"></textarea>
                            <p class="text-gray-300 mt-4">📸 포토 미션: 거대한 메인 수조를 배경으로 친구들과 단체 사진 찍기!</p>
                            <input type="file" id="photo_aqua" accept="image/*" class="savable w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0"/>
                            <div class="mt-4 photo-placeholder"><img id="preview_aqua" class="max-h-60 rounded-lg"/></div>
                        </div>
                        <div class="space-y-4 mb-6 border-b-2 border-slate-700 pb-6">
                            <h3 class="text-xl font-semibold text-gray-200">성읍민속마을</h3>
                            <p class="text-gray-300">Q. '정낭' 막대기가 모두 걸려있으면 어떤 뜻일까요?</p>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_seongeup" value="외출 중" class="savable"><span>외출 중이니 들어오지 마세요.</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_seongeup" value="주인 있음" class="savable"><span>집에 주인이 있으니 들어오세요.</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_seongeup" value="장기 부재" class="savable"><span>오랫동안 집을 비울 예정입니다.</span></label>
                            </div>
                            <p class="text-gray-300 mt-4">📸 포토 미션: 돌하르방 옆에서 또는 초가집을 배경으로 사진 찍기!</p>
                            <input type="file" id="photo_seongeup" accept="image/*" class="savable w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0"/>
                            <div class="mt-4 photo-placeholder"><img id="preview_seongeup" class="max-h-60 rounded-lg"/></div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-xl font-semibold text-gray-200">산굼부리</h3>
                            <p class="text-gray-300">Q. 산굼부리는 화산활동으로 만들어진 무엇일까요?</p>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_sangumburi" value="화구" class="savable"><span>화구 (분화구)</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_sangumburi" value="용암동굴" class="savable"><span>용암동굴</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_sangumburi" value="주상절리" class="savable"><span>주상절리</span></label>
                            </div>
                            <p class="text-gray-300 mt-4">산굼부리에서 본 풍경과 느낀 점을 자유롭게 작성해보세요.</p>
                            <textarea id="exp_sangumburi" class="savable w-full h-24 p-2 bg-gray-700 rounded-md"></textarea>
                        </div>
                    </div>
                    
                    <!-- 2일차 완료 버튼 -->
                    <div class="text-center">
                        <button id="complete-day2-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">
                            🎯 2일차 완료하고 이미지 저장하기
                        </button>
                        <div id="day2-status" class="mt-2 text-sm text-gray-400"></div>
                    </div>
                </div>

                <div id="day3" class="tab-panel space-y-6 hidden">
                    <div id="day3-content" class="bg-slate-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold text-blue-300 mb-4">3일차: 제주의 예술과 추억을 담아</h2>
                        <div class="space-y-4 mb-6 border-b-2 border-slate-700 pb-6">
                            <h3 class="text-xl font-semibold text-gray-200">아르떼뮤지엄</h3>
                            <p class="text-gray-300">Q. 아르떼뮤지엄의 '영원한 자연'을 의미하는 영문 테마는?</p>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_arte" value="ENDLESS" class="savable"><span>ENDLESS NATURE</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_arte" value="ETERNAL" class="savable"><span>ETERNAL NATURE</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_arte" value="FOREVER" class="savable"><span>FOREVER NATURE</span></label>
                            </div>
                            <p class="text-gray-300 mt-4">📸 포토 미션: 가장 마음에 드는 전시 공간에서 '인생샷' 남기기!</p>
                            <input type="file" id="photo_arte" accept="image/*" class="savable w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0"/>
                            <div class="mt-4 photo-placeholder"><img id="preview_arte" class="max-h-60 rounded-lg"/></div>
                        </div>
                        <div class="space-y-4 mb-6 border-b-2 border-slate-700 pb-6">
                            <h3 class="text-xl font-semibold text-gray-200">국립제주박물관 또는 제주수목테마파크</h3>
                            <p class="text-gray-300">Q. 국립제주박물관에는 무엇과 관련된 자료가 많이 전시되어 있나요?</p>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_museum" value="제주 4.3사건" class="savable"><span>제주 4.3사건</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_museum" value="제주 해녀 문화" class="savable"><span>제주 해녀 문화</span></label>
                                <label class="flex items-center space-x-2"><input type="radio" name="quiz_museum" value="제주의 화산활동" class="savable"><span>제주의 화산활동</span></label>
                            </div>
                            <p class="text-gray-300 mt-4">박물관에서 가장 인상깊었던 전시물이나 배운 점을 자유롭게 적어주세요.</p>
                            <textarea id="exp_museum" class="savable w-full h-24 p-2 bg-gray-700 rounded-md"></textarea>
                        </div>
                        <div class="space-y-4">
                            <h3 class="text-xl font-semibold text-gray-200">제주에서의 마지막 기록</h3>
                            <p class="text-gray-300">용두암이나 용연구름다리를 보고 느낀 점을 자유롭게 적어주세요.</p>
                            <textarea id="exp_yongduam" class="savable w-full h-24 p-2 bg-gray-700 rounded-md"></textarea>
                            <p class="text-gray-300 mt-4">2박 3일 여행에 대한 최종 한 줄 평을 남겨주세요!</p>
                            <textarea id="exp_final" class="savable w-full h-24 p-2 bg-gray-700 rounded-md"></textarea>
                        </div>
                    </div>
                    
                    <!-- 3일차 완료 버튼과 최종 보고서 버튼 -->
                    <div class="text-center">
                        <button id="complete-day3-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">
                            🎯 3일차 완료하고 이미지 저장하기
                        </button>
                        <div id="day3-status" class="mt-2 text-sm text-gray-400"></div>
                        
                        <!-- 최종 통합 보고서 버튼 (3일차 탭으로 이동) -->
                        <button id="show-result-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg mt-6">
                            🏆 최종 통합 보고서 만들기
                        </button>
                    </div>
                </div>
            </main>
        </form>
        
        <!-- 백업/불러오기 영역 -->
        <div class="bg-slate-800 p-4 rounded-lg shadow-md mt-8">
            <div class="text-center mb-3">
                <h4 class="text-blue-300 font-semibold">📱 다른 기기에서도 작업을 이어가려면</h4>
            </div>
            <div class="flex flex-wrap justify-center items-center space-x-2 md:space-x-4">
                <button id="export-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <span class="mr-1">💾</span> 작업 백업하기
                </button>
                <label class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer flex items-center">
                    <span class="mr-1">📂</span> 백업 불러오기
                    <input type="file" id="import-file" accept=".jeju,.json" class="hidden" />
                </label>
                <button id="reset-btn" class="bg-gray-600 hover:bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-lg">
                    전체 초기화
                </button>
            </div>
            <p class="text-xs text-center text-gray-400 mt-3">* 백업 파일은 다른 기기에서 이어서 작업할 때 필요합니다</p>
        </div>
        
        <footer class="mt-4 text-center text-sm text-gray-500">
            <p>개발: AISL Lab | 문의: <a href="https://www.facebook.com/playrurulala?locale=ko_KR" target="_blank" class="text-blue-400 hover:text-blue-300">룰루랄라 한기쌤</a> | 2025년 대구 교사연구회</p>
        </footer>
    </div>

    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center p-4 hidden">
        <div id="result-modal-content" class="bg-slate-800 text-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                 <div id="result-modal-header" class="flex justify-between items-center border-b-2 border-blue-500 pb-3 mb-4">
                    <h2 class="text-2xl font-bold text-blue-300">나의 제주 학습일지</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div id="result-content" class="space-y-4 text-gray-300 text-sm">
                    </div>
                <div class="mt-6 text-center">
                     <button id="print-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                        🖨️ 인쇄하기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 자동 저장 알림 -->
    <div id="autosave-indicator" class="fixed bottom-4 right-4 bg-green-600 text-white px-3 py-1 rounded-lg text-sm opacity-0 transition-opacity duration-300">
        ✅ 자동 저장됨
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_KEY = 'jejuFieldTripData';
        const IMAGES_KEY = 'jejuFieldTripImages';
        const BACKUP_GUIDE_KEY = 'jejuBackupGuideShown';
        const form = document.getElementById('main-form');
        const savableInputs = form.querySelectorAll('.savable');
        const autosaveIndicator = document.getElementById('autosave-indicator');
        const backupGuide = document.getElementById('backup-guide');

        // ======== 이미지 저장 및 진행률 관리 ========
        
        const dayImages = {
            day1: null,
            day2: null,
            day3: null
        };

        // 저장된 이미지들 불러오기
        const loadSavedImages = () => {
            const saved = localStorage.getItem(IMAGES_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(dayImages, parsed);
                updateProgress();
            }
        };

        // 이미지 저장
        const saveDayImage = (day, imageData) => {
            dayImages[day] = imageData;
            localStorage.setItem(IMAGES_KEY, JSON.stringify(dayImages));
            updateProgress();
        };

        // 진행률 업데이트
        const updateProgress = () => {
            const progressDots = {
                day1: document.getElementById('progress-dot-1'),
                day2: document.getElementById('progress-dot-2'),
                day3: document.getElementById('progress-dot-3')
            };

            Object.keys(dayImages).forEach(day => {
                const dot = progressDots[day];
                const statusEl = document.getElementById(`${day}-status`);
                
                if (dayImages[day]) {
                    dot.className = 'w-3 h-3 rounded-full progress-completed';
                    if (statusEl) {
                        statusEl.innerHTML = '✅ 완료됨 (이미지 저장됨)';
                        statusEl.className = 'mt-2 text-sm text-green-400';
                    }
                } else {
                    dot.className = 'w-3 h-3 rounded-full progress-inactive';
                    if (statusEl) {
                        statusEl.innerHTML = '';
                    }
                }
            });
        };

        // 각 일차별 이미지 생성 및 다운로드
        const generateDayImage = async (day) => {
            const contentEl = document.getElementById(`${day}-content`);
            const btn = document.getElementById(`complete-${day}-btn`);
            
            btn.innerHTML = '📸 이미지 생성 중...';
            btn.disabled = true;
            
            try {
                // 기본 정보도 포함하기 위해 임시 컨테이너 생성
                const tempContainer = document.createElement('div');
                tempContainer.style.padding = '20px';
                tempContainer.style.backgroundColor = '#1e293b';
                tempContainer.style.color = 'white';
                tempContainer.style.fontFamily = 'Pretendard, sans-serif';
                tempContainer.style.width = '800px';
                
                // 기본 정보 추가
                const isTeamMode = form.querySelector('input[name="mode"]:checked').value === 'team';
                const getTextValue = (id) => document.getElementById(id).value.trim() || '작성 안함';
                
                const basicInfo = document.createElement('div');
                basicInfo.style.marginBottom = '20px';
                basicInfo.style.padding = '15px';
                basicInfo.style.backgroundColor = '#374151';
                basicInfo.style.borderRadius = '8px';
                
                let teamInfoHtml = '';
                if (isTeamMode && getTextValue('team_name') !== '작성 안함') {
                    teamInfoHtml = `
                        <div style="margin-top: 10px; padding: 10px; background-color: #4b5563; border-radius: 6px;">
                            <h4 style="font-weight: bold; color: #93c5fd; margin-bottom: 5px;">🏆 팀 정보</h4>
                            <p><strong>팀명:</strong> ${getTextValue('team_name')}</p>
                            <p><strong>내 역할:</strong> ${getTextValue('team_role')}</p>
                        </div>`;
                }
                
                basicInfo.innerHTML = `
                    <h3 style="font-size: 18px; font-weight: bold; color: #93c5fd; margin-bottom: 10px;">✈️ 다다익선 제주 현장학습</h3>
                    <p><strong>학교:</strong> ${getTextValue('student_school')}</p>
                    <p><strong>학년:</strong> ${getTextValue('student_grade')}</p>
                    <p><strong>이름:</strong> ${getTextValue('student_name')}</p>
                    ${teamInfoHtml}
                `;
                
                tempContainer.appendChild(basicInfo);
                
                // 해당 일차 내용 복사
                const clonedContent = contentEl.cloneNode(true);
                tempContainer.appendChild(clonedContent);
                
                // 임시로 body에 추가
                document.body.appendChild(tempContainer);
                
                const canvas = await html2canvas(tempContainer, {
                    backgroundColor: '#1e293b',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                });
                
                // 임시 컨테이너 제거
                document.body.removeChild(tempContainer);
                
                const imageData = canvas.toDataURL('image/png');
                
                // 이미지 저장
                saveDayImage(day, imageData);
                
                // 이미지 다운로드
                const link = document.createElement('a');
                const dayNum = day.replace('day', '');
                const fileName = isTeamMode && getTextValue('team_name') !== '작성 안함' 
                    ? `제주학습_${dayNum}일차_${getTextValue('team_name')}_${getTextValue('student_name')}.png`
                    : `제주학습_${dayNum}일차_${getTextValue('student_name')}.png`;
                    
                link.download = fileName;
                link.href = imageData;
                link.click();
                
                btn.innerHTML = '✅ 완료! 이미지가 저장되었습니다';
                btn.className = 'bg-gray-600 text-white font-bold py-3 px-6 rounded-lg cursor-not-allowed';
                
                // 작업이 완료되었으니 백업을 권장
                showNotification('🔔 중요한 작업을 완료했습니다! 아래 "작업 백업하기" 버튼으로 저장하세요', 'info', 5000);
                
            } catch (error) {
                console.error('이미지 생성 실패:', error);
                btn.innerHTML = '❌ 이미지 생성 실패 - 다시 시도';
                btn.disabled = false;
                btn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg';
            }
        };
        
        // 안내/일정 PDF 다운로드 함수
        const downloadGuidePDF = async () => {
            const downloadBtn = document.getElementById('download-guide-btn');
            downloadBtn.innerHTML = '📄 PDF 생성 중...';
            downloadBtn.disabled = true;
            
            try {
                showLoading('안내/일정 PDF 생성 중...');
                
                // jsPDF 초기화
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // 가이드 콘텐츠 요소
                const guideContent = document.getElementById('guide-content');
                
                // 콘텐츠 전체 캡처 전 임시 컨테이너 생성 (학생 정보 제외)
                const tempContainer = document.createElement('div');
                tempContainer.style.backgroundColor = '#ffffff';
                tempContainer.style.color = '#000000';
                tempContainer.style.padding = '10px';
                
                // 제목 추가
                const titleElement = document.createElement('h1');
                titleElement.textContent = '✈️ 다다익선 제주 현장학습 안내';
                titleElement.style.fontSize = '24px';
                titleElement.style.fontWeight = 'bold';
                titleElement.style.textAlign = 'center';
                titleElement.style.marginBottom = '20px';
                titleElement.style.color = '#1e40af';
                tempContainer.appendChild(titleElement);
                
                // 일정, 안전수칙, 준비물 섹션 복제
                const sections = guideContent.querySelectorAll('.bg-slate-800:not(:first-child)');
                
                // 각 섹션 내용 복사
                sections.forEach(section => {
                    const cloned = section.cloneNode(true);
                    tempContainer.appendChild(cloned);
                });
                
                // 임시로 body에 추가
                document.body.appendChild(tempContainer);
                
                // HTML2Canvas 설정
                const canvas = await html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    onclone: (clonedDoc, clonedElement) => {
                        // 클론된 요소의 스타일 수정
                        clonedElement.querySelectorAll('*').forEach(el => {
                            if (el.style) {
                                if (el.tagName === 'H2' || el.tagName === 'H3') {
                                    el.style.color = '#000066';
                                } else {
                                    el.style.color = '#000000';
                                }
                                el.style.backgroundColor = 'transparent';
                            }
                        });
                        
                        // 배경색 변경
                        clonedElement.querySelectorAll('.bg-slate-800, .bg-slate-700, .bg-blue-900, .bg-red-900').forEach(el => {
                            el.style.backgroundColor = '#f8f9fa';
                            el.style.border = '1px solid #dee2e6';
                            el.style.borderRadius = '6px';
                        });
                        
                        // 테이블 스타일 변경
                        clonedElement.querySelectorAll('table').forEach(table => {
                            table.style.borderCollapse = 'collapse';
                            table.style.width = '100%';
                            table.querySelectorAll('th, td').forEach(cell => {
                                cell.style.border = '1px solid #dee2e6';
                                cell.style.padding = '8px';
                                cell.style.color = '#000000';
                            });
                            table.querySelectorAll('th').forEach(th => {
                                th.style.backgroundColor = '#e9ecef';
                                th.style.color = '#000000';
                                th.style.fontWeight = 'bold';
                            });
                            table.querySelectorAll('tr').forEach(tr => {
                                tr.style.backgroundColor = '#ffffff';
                            });
                        });
                    }
                });
                
                // 임시 컨테이너 제거
                document.body.removeChild(tempContainer);
                
                // 캔버스 크기 계산
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const imgWidth = 190; // A4 너비에서 여백 제외
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // 여러 페이지로 나누기
                const pageHeight = 277; // A4 높이에서 여백 제외
                let heightLeft = imgHeight;
                let position = 0;
                let pageCount = 0;
                
                // 첫 페이지 추가
                doc.addImage(imgData, 'JPEG', 10, 10, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // 필요한 만큼 페이지 추가
                while (heightLeft > 0) {
                    pageCount++;
                    position = -pageHeight * pageCount;
                    doc.addPage();
                    doc.addImage(imgData, 'JPEG', 10, position + 10, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // 파일명 설정 및 다운로드
                const fileName = `제주현장학습_안내_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);
                
                hideLoading();
                downloadBtn.innerHTML = '📋 안내/일정 PDF로 다운로드하기';
                downloadBtn.disabled = false;
                
            } catch (error) {
                hideLoading();
                console.error('PDF 생성 오류:', error);
                alert('PDF 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
                downloadBtn.innerHTML = '📋 안내/일정 PDF로 다운로드하기';
                downloadBtn.disabled = false;
            }
        };

        // ======== 자동 저장 및 불러오기 기능 ========

        // 데이터 저장 함수
        const saveData = () => {
            const data = {};
            savableInputs.forEach(input => {
                if (input.type === 'checkbox') {
                    data[input.id] = input.checked;
                } else if (input.type === 'radio') {
                    if (input.checked) {
                        data[input.name] = input.value;
                    }
                } else if (input.type === 'file') {
                    // 파일은 직접 저장 못하므로, 미리보기 이미지의 데이터 URL을 저장
                    const previewImg = document.getElementById(input.id.replace('photo_', 'preview_'));
                    if (previewImg && previewImg.src.startsWith('data:image')) {
                        data[input.id] = previewImg.src;
                    }
                } else {
                    data[input.id] = input.value;
                }
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            
            // 자동 저장 표시
            showAutosaveIndicator();
        };

        // 데이터 불러오기 함수
        const loadData = () => {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) return;

            const data = JSON.parse(savedData);
            savableInputs.forEach(input => {
                if (data[input.id] !== undefined) {
                    if (input.type === 'checkbox') {
                        input.checked = data[input.id];
                    } else if (input.type === 'file') {
                        // 저장된 데이터 URL로 이미지 미리보기 복원
                        const previewImg = document.getElementById(input.id.replace('photo_', 'preview_'));
                        if (previewImg && data[input.id]) {
                            previewImg.src = data[input.id];
                            previewImg.parentElement.classList.remove('photo-placeholder');
                        }
                    } else {
                        input.value = data[input.id];
                    }
                } else if (input.type === 'radio' && data[input.name] !== undefined) {
                    if (input.value === data[input.name]) {
                        input.checked = true;
                    }
                }
            });
        };
        
        // ======== 백업 관련 기능 ========
        
        // 데이터 내보내기 함수
        const exportData = () => {
            // 현재 입력 데이터와 이미지를 포함한 객체 생성
            const exportObj = {
                formData: JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'),
                images: JSON.parse(localStorage.getItem(IMAGES_KEY) || '{}')
            };
            
            // 학생 이름과 학교 정보 가져오기
            const studentName = document.getElementById('student_name').value || '학생';
            const schoolName = document.getElementById('student_school').value || '';
            
            // JSON 파일로 변환하여 다운로드
            const dataStr = JSON.stringify(exportObj);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileName = `제주학습_${schoolName ? schoolName + '_' : ''}${studentName}_${new Date().toLocaleDateString('ko-KR').replace(/\./g, '').replace(/\s/g, '')}.jeju`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileName);
            linkElement.click();
            
            // 성공 메시지 표시
            showNotification('✅ 백업 완료! 파일이 저장되었습니다', 'success');
        };

        // 데이터 불러오기 함수
        const importData = (file) => {
            // 파일 확장자 확인 (.json 또는 .jeju)
            if (!file.name.endsWith('.json') && !file.name.endsWith('.jeju')) {
                showNotification('❌ 올바른 백업 파일이 아닙니다', 'error');
                return;
            }
            
            showNotification('⏳ 백업 파일 불러오는 중...', 'info');
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    // 불러온 데이터 저장
                    if (importedData.formData) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData.formData));
                    }
                    
                    if (importedData.images) {
                        localStorage.setItem(IMAGES_KEY, JSON.stringify(importedData.images));
                    }
                    
                    // 성공 메시지와 함께 페이지 새로고침
                    showNotification('✅ 백업을 성공적으로 불러왔습니다!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                    
                } catch (error) {
                    showNotification('❌ 파일을 읽는 중 오류가 발생했습니다', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        };
        
        // 알림 표시 함수
        const showNotification = (message, type = 'info', duration = 3000) => {
            // 이미 있는 알림 제거
            const existingNotification = document.getElementById('notification');
            if (existingNotification) {
                document.body.removeChild(existingNotification);
            }
            
            // 알림 타입에 따른 색상 설정
            let bgColor = 'bg-blue-600';
            if (type === 'success') bgColor = 'bg-green-600';
            if (type === 'error') bgColor = 'bg-red-600';
            
            // 알림 요소 생성
            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 notification`;
            notification.innerHTML = message;
            
            // 알림 추가 및 자동 제거
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 500);
            }, duration);
        };
        
        // 자동 저장 표시기 함수
        const showAutosaveIndicator = () => {
            // 자동 저장 표시기 표시
            autosaveIndicator.style.opacity = '1';
            
            // 2초 후 자동 숨김
            setTimeout(() => {
                autosaveIndicator.style.opacity = '0';
            }, 2000);
        };

        // 각 입력 요소에 자동 저장 이벤트 리스너 추가
        savableInputs.forEach(input => {
            const eventType = (input.type === 'text' || input.tagName === 'TEXTAREA') ? 'input' : 'change';
            input.addEventListener(eventType, (e) => {
                if (e.target.type === 'file') {
                     // 파일 선택 시 FileReader로 Data URL을 만들어 저장 준비
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        const previewImg = document.getElementById(e.target.id.replace('photo_', 'preview_'));
                        reader.onload = (event) => {
                            previewImg.src = event.target.result;
                            previewImg.parentElement.classList.remove('photo-placeholder');
                            saveData(); // 이미지가 로드된 후 저장
                        };
                        reader.readAsDataURL(file);
                    }
                } else {
                    saveData();
                }
            });
        });
        
        // 주기적 자동 저장 (3분마다)
        setInterval(saveData, 180000);
        
        // 페이지를 떠날 때 저장
        window.addEventListener('beforeunload', saveData);
        
        // 페이지 로드 시 데이터 불러오기 실행
        loadData();
        loadSavedImages();
        
        // 백업 안내 표시 관리
        if (!localStorage.getItem(BACKUP_GUIDE_KEY)) {
            backupGuide.style.display = 'block';
        } else {
            backupGuide.style.display = 'none';
        }
        
        // 백업 안내 닫기 버튼
        document.getElementById('hide-guide-btn').addEventListener('click', () => {
            backupGuide.style.display = 'none';
            localStorage.setItem(BACKUP_GUIDE_KEY, 'true');
        });

        // ======== 일차별 완료 버튼 이벤트 ========
        document.getElementById('complete-day1-btn').addEventListener('click', () => generateDayImage('day1'));
        document.getElementById('complete-day2-btn').addEventListener('click', () => generateDayImage('day2'));
        document.getElementById('complete-day3-btn').addEventListener('click', () => generateDayImage('day3'));
        
        // 안내/일정 다운로드 버튼 이벤트
        document.getElementById('download-guide-btn').addEventListener('click', downloadGuidePDF);
        
        // 백업/복원 버튼 이벤트
        document.getElementById('export-btn').addEventListener('click', exportData);
        document.getElementById('import-file').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                importData(e.target.files[0]);
            }
        });

        // ======== 개인/팀 모드 전환 기능 ========
        const modeRadios = form.querySelectorAll('input[name="mode"]');
        const teamInfoSection = document.getElementById('team_info_section');
        const nameLabelSuffix = document.getElementById('name_label_suffix');

        const toggleMode = () => {
            const isTeamMode = form.querySelector('input[name="mode"]:checked').value === 'team';
            if (isTeamMode) {
                teamInfoSection.classList.remove('hidden');
                nameLabelSuffix.textContent = '(내 이름)';
            } else {
                teamInfoSection.classList.add('hidden');
                nameLabelSuffix.textContent = '';
            }
        };

        modeRadios.forEach(radio => {
            radio.addEventListener('change', toggleMode);
        });

        // 초기 모드 설정
        toggleMode();

        // ======== 진행 표시기 관리 ========
        const updateProgressIndicator = (tabId) => {
            // 모든 진행 표시기 초기화
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById(`progress-dot-${i}`);
                const text = document.getElementById(`progress-text-${i}`);
                
                // 완료된 일차는 녹색으로 유지
                if (dayImages[`day${i}`]) {
                    dot.className = 'w-3 h-3 rounded-full progress-completed';
                } else {
                    dot.className = 'w-3 h-3 rounded-full progress-inactive';
                }
                text.className = 'text-sm text-gray-400';
            }
            
            // 현재 선택된 탭에 해당하는 진행 표시기 활성화
            if (tabId === 'day1' || tabId === 'day2' || tabId === 'day3') {
                const dayNum = parseInt(tabId.replace('day', ''));
                const dot = document.getElementById(`progress-dot-${dayNum}`);
                const text = document.getElementById(`progress-text-${dayNum}`);
                
                // 완료된 일차는 녹색 유지, 그렇지 않으면 활성화 색상으로 변경
                if (!dayImages[tabId]) {
                    dot.className = 'w-3 h-3 rounded-full progress-active';
                }
                text.className = 'text-sm text-blue-300 font-semibold';
                
                // 진행 표시기 사이 선 업데이트
                updateProgressLines(dayNum);
            } else {
                // 안내/일정 탭인 경우 모든 선 비활성화
                document.getElementById('progress-line-1-2').className = 'w-8 h-0.5 progress-line-inactive';
                document.getElementById('progress-line-2-3').className = 'w-8 h-0.5 progress-line-inactive';
            }
        };
        
        // 진행 표시기 선 업데이트
        const updateProgressLines = (dayNum) => {
            const line1to2 = document.getElementById('progress-line-1-2');
            const line2to3 = document.getElementById('progress-line-2-3');
            
            // 선 초기화
            line1to2.className = 'w-8 h-0.5 progress-line-inactive';
            line2to3.className = 'w-8 h-0.5 progress-line-inactive';
            
            // 완료된 일차에 따라 선 활성화
            if (dayImages.day1 && dayImages.day2) {
                line1to2.className = 'w-8 h-0.5 progress-line-active';
            }
            if (dayImages.day2 && dayImages.day3) {
                line2to3.className = 'w-8 h-0.5 progress-line-active';
            }
            
            // 현재 선택된 일차에 따른 선 업데이트
            if (dayNum === 2) {
                line1to2.className = 'w-8 h-0.5 progress-line-active';
            } else if (dayNum === 3) {
                line1to2.className = 'w-8 h-0.5 progress-line-active';
                line2to3.className = 'w-8 h-0.5 progress-line-active';
            }
        };

        // ======== 탭 기능 ========
        const tabButtons = document.getElementById('tab-buttons');
        const tabPanels = document.querySelectorAll('#tab-content .tab-panel');
        tabButtons.addEventListener('click', (e) => {
            const targetButton = e.target.closest('button');
            if (!targetButton) return;
            const tabId = targetButton.dataset.tab;
            
            // 탭 버튼 스타일 업데이트
            tabButtons.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('tab-active', 'bg-blue-600');
                btn.classList.add('tab-inactive', 'bg-gray-700');
            });
            targetButton.classList.add('tab-active', 'bg-blue-600');
            targetButton.classList.remove('tab-inactive', 'bg-gray-700');
            
            // 탭 패널 표시/숨김
            tabPanels.forEach(panel => panel.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            
            // 진행 표시기 업데이트
            updateProgressIndicator(tabId);
        });

        // ======== 결과 모달 및 인쇄 기능 ========
        const showResultBtn = document.getElementById('show-result-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const resultModal = document.getElementById('result-modal');
        const resultContent = document.getElementById('result-content');
        const printBtn = document.getElementById('print-btn');

        const getTextValue = (id) => document.getElementById(id).value.trim() || '작성 안함';
        const getRadioValue = (name) => {
            const radio = form.querySelector(`input[name="${name}"]:checked`);
            return radio ? radio.parentElement.textContent.trim() : '선택 안함';
        };
        const getPhotoFileName = (id) => document.getElementById(id).files.length > 0 ? document.getElementById(id).files[0].name : '사진 없음';

        showResultBtn.addEventListener('click', async () => {
            const isTeamMode = form.querySelector('input[name="mode"]:checked').value === 'team';
            const getTextValue = (id) => document.getElementById(id).value.trim() || '작성 안함';
            
            const titleSuffix = isTeamMode && getTextValue('team_name') !== '작성 안함' 
                ? ` - ${getTextValue('team_name')}` 
                : '';

            // 모달 제목 업데이트
            const modalTitle = document.querySelector('#result-modal-header h2');
            modalTitle.textContent = `🏆 제주 현장학습 완전정복${titleSuffix}`;

            // 저장된 이미지들로 통합 보고서 생성
            let finalContent = `
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-blue-300 mb-2">✈️ 2박 3일 제주 현장학습 완전정복</h3>
                    <p class="text-gray-400">${getTextValue('student_school')} ${getTextValue('student_grade')} ${getTextValue('student_name')}</p>
                    ${isTeamMode && getTextValue('team_name') !== '작성 안함' ? `<p class="text-blue-300 font-semibold">🏆 ${getTextValue('team_name')}</p>` : ''}
                    <div class="mt-4 text-sm text-gray-500">
                        생성일: ${new Date().toLocaleDateString('ko-KR')}
                    </div>
                </div>
            `;

            // 각 일차별 이미지 포함
            ['day1', 'day2', 'day3'].forEach((day, index) => {
                const dayNum = index + 1;
                const dayTitle = ['건축과 자연의 만남', '바다와 전통의 조화', '예술과 추억 완성'][index];
                
                finalContent += `
                    <div class="mb-8 p-4 bg-slate-700 rounded-lg">
                        <h4 class="text-lg font-bold text-blue-300 mb-3">📅 ${dayNum}일차: ${dayTitle}</h4>
                `;
                
                if (dayImages[day]) {
                    finalContent += `
                        <div class="text-center">
                            <img src="${dayImages[day]}" alt="${dayNum}일차 학습 결과" class="w-full rounded-lg border-2 border-slate-600" />
                            <p class="text-xs text-green-400 mt-2">✅ 학습 완료 및 저장됨</p>
                        </div>
                    `;
                } else {
                    finalContent += `
                        <div class="text-center p-8 border-2 border-dashed border-gray-600 rounded-lg">
                            <p class="text-gray-400">📋 ${dayNum}일차 학습이 아직 완료되지 않았습니다</p>
                            <p class="text-sm text-gray-500 mt-2">"${dayNum}일차 완료하고 이미지 저장하기" 버튼을 눌러주세요</p>
                        </div>
                    `;
                }
                
                finalContent += '</div>';
            });

            // 진행률 요약
            const completedDays = Object.values(dayImages).filter(img => img !== null).length;
            finalContent += `
                <div class="mt-6 p-4 bg-slate-600 rounded-lg text-center">
                    <h4 class="font-bold text-blue-300 mb-2">📊 학습 진행률</h4>
                    <div class="text-2xl font-bold text-green-400">${completedDays}/3일 완료</div>
                    <div class="w-full bg-gray-700 rounded-full h-3 mt-2">
                        <div class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width: ${(completedDays/3)*100}%"></div>
                    </div>
                    ${completedDays === 3 ? 
                        '<p class="text-green-300 mt-2 font-semibold">🎉 모든 학습이 완료되었습니다!</p>' : 
                        '<p class="text-yellow-300 mt-2">⏳ 학습을 계속 진행해주세요</p>'
                    }
                </div>
            `;

            resultContent.innerHTML = finalContent;
            resultModal.classList.remove('hidden');
        });
        
        closeModalBtn.addEventListener('click', () => resultModal.classList.add('hidden'));
        
        // PDF 생성 시작 시 로딩 오버레이 표시
        function showLoading(message) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner"></div>
                <div>${message}</div>
            `;
            overlay.id = 'pdf-loading-overlay';
            document.body.appendChild(overlay);
        }

        // PDF 생성 완료 시 로딩 오버레이 제거
        function hideLoading() {
            const overlay = document.getElementById('pdf-loading-overlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
        }
        
        // 인쇄 버튼 이벤트 핸들러 교체
        printBtn.addEventListener('click', async function() {
            try {
                showLoading('PDF 생성 중... 잠시만 기다려주세요');
                this.innerHTML = '📄 PDF 생성 중...';
                this.disabled = true;
                
                // jsPDF 초기화
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // 결과 콘텐츠 요소
                const resultContent = document.getElementById('result-content');
                
                // 콘텐츠 전체 캡처 전 배경색 임시 변경
                const originalBgColor = resultContent.style.backgroundColor;
                resultContent.style.backgroundColor = '#ffffff';
                
                // 콘텐츠를 섹션별로 분리
                const sections = [
                    document.querySelector('#result-modal-header').parentElement, // 제목 섹션
                    ...resultContent.querySelectorAll('.mb-8') // 일차별 섹션들
                ];
                
                // 각 섹션을 개별 페이지로 변환
                for (let i = 0; i < sections.length; i++) {
                    const section = sections[i];
                    
                    // 첫 페이지가 아니면 새 페이지 추가
                    if (i > 0) {
                        doc.addPage();
                    }
                    
                    // 이미지 로딩 대기
                    const images = section.querySelectorAll('img');
                    await Promise.all([...images].map(img => {
                        if (!img.src || img.complete) return Promise.resolve();
                        return new Promise(resolve => {
                            img.onload = resolve;
                            img.onerror = resolve;
                        });
                    }));
                    
                    // 섹션을 캔버스로 변환
                    const canvas = await html2canvas(section, {
                        scale: 2, // 고품질
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        onclone: (clonedDoc, clonedElement) => {
                            // 클론된 요소의 스타일 수정
                            clonedElement.style.color = '#000000';
                            clonedElement.querySelectorAll('*').forEach(el => {
                                if (el.style) {
                                    el.style.color = el.tagName === 'H2' || el.tagName === 'H3' || 
                                                    el.tagName === 'H4' ? '#000066' : '#000000';
                                    el.style.backgroundColor = 'transparent';
                                }
                            });
                        }
                    });
                    
                    // 캔버스를 PDF에 추가
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const imgWidth = 190; // A4 너비에서 여백 제외
                    const pageHeight = 277; // A4 높이에서 여백 제외
                    
                    // 이미지 높이 계산
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // 높이가 페이지를 초과하면 여러 페이지로 분할
                    if (imgHeight <= pageHeight) {
                        // 한 페이지에 들어가는 경우
                        doc.addImage(imgData, 'JPEG', 10, 10, imgWidth, imgHeight);
                    } else {
                        // 여러 페이지에 걸치는 경우
                        let heightLeft = imgHeight;
                        let position = 0;
                        let page = 0;
                        
                        while (heightLeft > 0) {
                            doc.addImage(imgData, 'JPEG', 10, 10 - position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                            position += pageHeight;
                            
                            if (heightLeft > 0) {
                                doc.addPage();
                                page++;
                            }
                        }
                    }
                }
                
                // 배경색 복원
                resultContent.style.backgroundColor = originalBgColor;
                
                // 파일명 설정
                const studentName = document.getElementById('student_name').value.trim() || '학생';
                const fileName = `제주학습_보고서_${studentName}_${new Date().toISOString().slice(0,10)}.pdf`;
                
                // PDF 다운로드
                doc.save(fileName);
                
                hideLoading();
                this.innerHTML = '🖨️ 인쇄하기';
                this.disabled = false;
                
            } catch (error) {
                hideLoading();
                console.error('PDF 생성 오류:', error);
                alert('PDF 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
                this.innerHTML = '🖨️ 인쇄하기';
                this.disabled = false;
            }
        });

        // ======== 초기화 기능 ========
        document.getElementById('reset-btn').addEventListener('click', () => {
            if(confirm('정말로 모든 작성 내용과 저장된 이미지를 영구적으로 삭제하시겠습니까?')) {
                form.reset();
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(IMAGES_KEY);
                
                // 이미지 데이터 초기화
                Object.keys(dayImages).forEach(day => {
                    dayImages[day] = null;
                });
                
                // 미리보기 이미지 초기화
                document.querySelectorAll('img[id^="preview_"]').forEach(img => {
                    img.src = '';
                    if(!img.parentElement.classList.contains('photo-placeholder')) {
                        img.parentElement.classList.add('photo-placeholder');
                    }
                });
                
                // 완료 버튼들 초기화
                ['day1', 'day2', 'day3'].forEach(day => {
                    const btn = document.getElementById(`complete-${day}-btn`);
                    btn.innerHTML = `🎯 ${day.replace('day', '')}일차 완료하고 이미지 저장하기`;
                    btn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg';
                    btn.disabled = false;
                });
                
                updateProgress();
                
                // 안내/일정 탭으로 초기화하고 진행 표시기 업데이트
                tabButtons.querySelector('button[data-tab="guide"]').click();
                updateProgressIndicator('guide');
                
                showNotification('✅ 모든 내용과 저장된 이미지가 삭제되었습니다.', 'success');
            }
        });
        
        // 페이지 로드 시 초기 진행 표시기 설정
        // 기본적으로 안내/일정 탭이 선택된 상태
        updateProgressIndicator('guide');
        
        // 첫 방문 시 백업 기능에 대한 안내 알림
        if (localStorage.getItem(STORAGE_KEY) && !localStorage.getItem(BACKUP_GUIDE_KEY)) {
            setTimeout(() => {
                showNotification('🔔 다른 기기나 브라우저에서 작업하려면 "작업 백업하기" 버튼을 사용하세요', 'info', 6000);
            }, 3000);
        }
    });
    </script>
</body>
</html>